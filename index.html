<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OSRS Herb Run Calculator</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
  }
  h1 {
    margin-bottom: 10px;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  select, input[type="number"] {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: none;
    font-size: 1rem;
  }
  input[type="checkbox"] {
    margin-right: 6px;
  }
  input[type="range"] {
    width: 100%;
  }
  button {
    margin-top: 15px;
    padding: 10px;
    font-size: 1rem;
    border-radius: 4px;
    border: none;
    background: #4caf50;
    color: white;
    cursor: pointer;
  }
  #result {
    margin-top: 20px;
    font-size: 1.2rem;
    background: #222;
    padding: 10px;
    border-radius: 6px;
  }
</style>
</head>
<body>
<h1>OSRS Herb Run Calculator</h1>
<form id="herbForm">
  <label for="seedSlider">Seed Type: <span id="seedLabel">Ranarr</span></label>
  <input type="range" id="seedSlider" min="0" max="1" step="1" value="0" />

  <label for="compost">Compost Type:</label>
  <select id="compost">
    <option value="none">None</option>
    <option value="compost">Compost</option>
    <option value="supercompost">Supercompost</option>
    <option value="ultracompost">Ultracompost</option>
  </select>

  <label for="output">Output Type:</label>
  <select id="output"></select>

  <label for="patches">Number of Patches:</label>
  <input type="number" id="patches" value="5" min="1" />

  <label><input type="checkbox" id="deaths" /> Account for 10% herb deaths</label>
  <label><input type="checkbox" id="secateurs" /> Using Magic Secateurs (+10% yield)</label>

  <button type="submit">Calculate Profit</button>
</form>
<div id="result"></div>

<script>
const itemIDs = {
  ranarr_seed: 5295,
  snapdragon_seed: 5300,
  grimy_ranarr: 207,
  clean_ranarr: 257,
  unf_ranarr: 99,
  prayer_potion: 2434,
  snape_grass: 231,
  vial: 227,
  grimy_snapdragon: 3051,
  clean_snapdragon: 3001,
  unf_snapdragon: 3004,
  saradomin_brew: 6687,
  crushed_nest: 6693,
  ultracompost: 21483
};

const yieldTable = {
  none: 6,
  compost: 7,
  supercompost: 8,
  ultracompost: 9
};

const outputIDs = {
  ranarr: {
    grimy: 'grimy_ranarr',
    clean: 'clean_ranarr',
    unf: 'unf_ranarr',
    potion: 'prayer_potion'
  },
  snapdragon: {
    grimy: 'grimy_snapdragon',
    clean: 'clean_snapdragon',
    unf: 'unf_snapdragon',
    potion: 'saradomin_brew'
  }
};

let priceData = {};

async function fetchPrices() {
  const res = await fetch('https://prices.runescape.wiki/api/v1/osrs/latest');
  const json = await res.json();
  priceData = json.data;
}

function getPrice(id) {
  return priceData[id]?.high || 0;
}

function calculateProfit(seed, compost, output, patches, deathsChecked, secateursChecked) {
  const herbType = seed.includes('ranarr') ? 'ranarr' : 'snapdragon';
  let avgYield = yieldTable[compost];
  if (secateursChecked) avgYield *= 1.1;
  if (deathsChecked) avgYield *= 0.9;
  const totalHerbs = avgYield * patches;

  const seedCost = getPrice(itemIDs[seed]) * patches;
  const outputID = itemIDs[outputIDs[herbType][output]];
  const outputPrice = getPrice(outputID);
  let totalOutputValue = totalHerbs * outputPrice;

  const compostCost = compost === 'ultracompost' ? getPrice(itemIDs.ultracompost) * patches : 0;

  if (output === 'potion') {
    const vialPrice = getPrice(itemIDs.vial);
    const secondID = herbType === 'ranarr' ? itemIDs.snape_grass : itemIDs.crushed_nest;
    const secondPrice = getPrice(secondID);
    const potionsMade = Math.floor(totalHerbs / 3);
    totalOutputValue = potionsMade * outputPrice;
    const potionCosts = potionsMade * (vialPrice + secondPrice);
    totalOutputValue -= potionCosts;
  }

  const netProfit = totalOutputValue - seedCost - compostCost;

  return {
    outputPrice,
    seedCost,
    totalOutputValue,
    netProfit,
    totalHerbs
  };
}

function updateOutputOptions(seedKey) {
  const outputSelect = document.getElementById('output');
  const herbType = seedKey.includes('ranarr') ? 'ranarr' : 'snapdragon';

  const options = {
    ranarr: [
      { value: 'grimy', label: 'Grimy' },
      { value: 'clean', label: 'Clean' },
      { value: 'unf', label: 'Unf Potion' },
      { value: 'potion', label: 'Prayer Potion' }
    ],
    snapdragon: [
      { value: 'grimy', label: 'Grimy' },
      { value: 'clean', label: 'Clean' },
      { value: 'unf', label: 'Unf Potion' },
      { value: 'potion', label: 'Saradomin Brew' }
    ]
  };

  outputSelect.innerHTML = '';
  options[herbType].forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    outputSelect.appendChild(option);
  });
}

fetchPrices().then(() => {
  document.getElementById('herbForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const seedKey = document.getElementById('seedSlider').value === '0' ? 'ranarr_seed' : 'snapdragon_seed';
    const compost = document.getElementById('compost').value;
    const output = document.getElementById('output').value;
    const patches = parseInt(document.getElementById('patches').value, 10);
    const deathsChecked = document.getElementById('deaths').checked;
    const secateursChecked = document.getElementById('secateurs').checked;

    const result = calculateProfit(seedKey, compost, output, patches, deathsChecked, secateursChecked);

    document.getElementById('result').innerHTML = `
      <strong>Total Herbs:</strong> ${result.totalHerbs.toFixed(1)}<br>
      <strong>Herb Price:</strong> ${result.outputPrice.toLocaleString()} gp<br>
      <strong>Total Output Value:</strong> ${result.totalOutputValue.toLocaleString()} gp<br>
      <strong>Total Seed Cost:</strong> ${result.seedCost.toLocaleString()} gp<br>
      <strong>Total Net Profit:</strong> ${result.netProfit.toLocaleString()} gp
    `;
  });

  updateOutputOptions('ranarr_seed');
});

document.getElementById('seedSlider').addEventListener('input', function () {
  const label = this.value === '0' ? 'Ranarr' : 'Snapdragon';
  document.getElementById('seedLabel').textContent = label;
  const seedKey = this.value === '0' ? 'ranarr_seed' : 'snapdragon_seed';
  updateOutputOptions(seedKey);
});
</script>
</body>
</html>
