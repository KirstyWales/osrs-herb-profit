<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OSRS Herb Farming Profit Calculator</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 2rem; }
    label, select, input, button { display: block; margin: 1rem 0; }
  </style>
</head>
<body>
  <h1>OSRS Herb Farming Profit Calculator</h1>
  <p><em>This calculator assumes the use of ultracompost and Magic Secateurs, yielding an average of 8.5 herbs per patch.</em></p>

  <label for="herbType">Herb Type:</label>
  <select id="herbType">
    <option value="ranarr">Ranarr</option>
    <option value="snapdragon">Snapdragon</option>
    <option value="toadflax">Toadflax</option>
  </select>

  <label for="productForm">Product Form:</label>
  <select id="productForm">
    <option value="grimy">Grimy Herb</option>
    <option value="unf">Unfinished Potion</option>
    <option value="finished">Finished Potion</option>
  </select>

  <label for="patches">Number of Herb Patches:</label>
  <input type="number" id="patches" value="5" min="1" />

  <button onclick="calculateProfit()">Calculate Profit</button>

  <pre id="result"></pre>

  <script>
    const API_URL = "https://prices.runescape.wiki/api/v1/osrs/latest";

    const ids = {
      ranarr: { seed: 5295, herb: 257, secondary: 231, unf: 91, potion: 139 },
      snapdragon: { seed: 5300, herb: 3000, secondary: 223, unf: 3004, potion: 3026 },
      toadflax: { seed: 5296, herb: 2998, secondary: 6693, unf: 3002, potion: 6687 },
      vial: 227,
      ultracompost: 21483
    };

    async function fetchPrices() {
      const response = await fetch(API_URL);
      const data = await response.json();
      return data.data;
    }

    async function calculateProfit() {
      const herbType = document.getElementById("herbType").value;
      const productForm = document.getElementById("productForm").value;
      const patches = parseInt(document.getElementById("patches").value);
      const herbsHarvested = patches * 8.5;

      const prices = await fetchPrices();

      const seedCost = prices[ids[herbType].seed].high;
      const compostCost = prices[ids.ultracompost].high;
      const herbPrice = prices[ids[herbType].herb].high;
      const vialCost = prices[ids.vial].high;
      const secondaryCost = prices[ids[herbType].secondary].high;
      const potionPrice = prices[ids[herbType].potion].high;
      const unfPrice = prices[ids[herbType].unf].high;

      let revenue = 0;
      if (productForm === "grimy") {
        revenue = herbsHarvested * herbPrice;
      } else if (productForm === "unf") {
        revenue = herbsHarvested * unfPrice;
      } else if (productForm === "finished") {
        revenue = herbsHarvested * potionPrice;
      }

      let cost = (seedCost + compostCost) * patches;
      if (productForm !== "grimy") {
        cost += herbsHarvested * vialCost;
      }
      if (productForm === "finished") {
        cost += herbsHarvested * secondaryCost;
      }

      const profit = revenue - cost;

      let herbloreXP = 0;
      let gpPerXP = null;
      let adjustedGpPerXp = null;

      if (productForm === "finished") {
        const xpPerPotion = {
          ranarr: 7.5 + 87.5,
          snapdragon: 11.8 + 142.5,
          toadflax: 8.0 + 180
        };

        herbloreXP = herbsHarvested * xpPerPotion[herbType];
        gpPerXP = profit / herbloreXP;

        // Compare against actual grimy profit
        const grimyRevenue = herbsHarvested * herbPrice;
        const grimyProfit = grimyRevenue - cost;
        const trueGpGain = profit - grimyProfit;
        adjustedGpPerXp = trueGpGain / herbloreXP;
      }

      document.getElementById("result").textContent = `
---
Herb Type: ${herbType.charAt(0).toUpperCase() + herbType.slice(1)}
Product Form: ${productForm.replace("unf", "Unfinished").replace("grimy", "Grimy").replace("finished", "Finished")}
Patches: ${patches}
Herbs Harvested: ${herbsHarvested.toFixed(1)}

Revenue: ${revenue.toLocaleString()} gp
Cost: ${cost.toLocaleString()} gp
Profit: ${profit.toLocaleString()} gp
${herbloreXP > 0 ? `Herblore XP per Run: ${herbloreXP.toLocaleString()} xp` : ""}
${gpPerXP !== null ? `GP per XP (raw profit): ${gpPerXP.toFixed(2)} gp/xp` : ""}
${adjustedGpPerXp !== null ? `GP per XP (vs. selling herbs with costs): ${adjustedGpPerXp.toFixed(2)} gp/xp` : ""}
`;
    }
  </script>
</body>
</html>
